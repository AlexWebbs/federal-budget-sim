<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>US Federal Budget Simulator :: HYPERDRIVE EDITION ::</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@300;400;500;700&family=Orbitron:wght@400;500;700;900&family=Press+Start+2P&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --neon-green: #00ff41;
            --electric-pink: #ff006e;
            --cyber-blue: #00d9ff;
            --holographic-purple: #8A2BE2; 
            --terminal-black: #0a0a0a;
            --chrome-silver: #c0c0c0; 
            --dark-chrome: #707070;
            --highlight-chrome: #f0f0f0;
            --amber-glow: #FFBF00;
            --scanline-alpha: rgba(0, 255, 65, 0.05); 
            
            --text-glow-strong: 0 0 3px var(--neon-green), 0 0 6px var(--neon-green);
            --text-glow-medium: 0 0 2px var(--cyber-blue), 0 0 4px var(--cyber-blue);
            --text-glow-pink: 0 0 3px var(--electric-pink), 0 0 5px var(--electric-pink);
            
            --background-gradient: linear-gradient(45deg, var(--terminal-black) 0%, #100010 30%, #001010 60%, var(--terminal-black) 100%); 
            --border-neon: 1px solid var(--neon-green);
            --border-cyber: 1px solid var(--cyber-blue);
        }

        body {
            font-family: 'Fira Code', monospace;
            background-color: var(--terminal-black);
            color: var(--neon-green); 
            position: relative; 
            overflow-x: hidden; /* Allow vertical scroll, prevent horizontal from blobs */
            background-image: var(--background-gradient); 
            background-size: 400% 400%;
            animation: gradientBG 30s ease infinite; 
        }
        
        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* --- Chrome Blob Background --- */
        .blob-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden; 
            z-index: -2; 
        }

        .blob {
            position: absolute;
            border-radius: 50%; 
            opacity: 0.3; 
            filter: blur(40px); 
            mix-blend-mode: screen; 
        }

        .blob-1 {
            width: 60vw; 
            height: 60vw;
            max-width: 700px; max-height: 700px;
            background: radial-gradient(circle at 30% 30%, var(--holographic-purple), var(--cyber-blue) 40%, var(--electric-pink) 70%, transparent 90%);
            animation: floatMorph1 35s infinite alternate ease-in-out;
        }

        .blob-2 {
            width: 50vw;
            height: 50vw;
            max-width: 600px; max-height: 600px;
            background: radial-gradient(circle at 70% 70%, var(--chrome-silver), var(--dark-chrome) 50%, var(--cyber-blue) 80%, transparent 95%);
            animation: floatMorph2 40s infinite alternate ease-in-out;
            opacity: 0.25;
        }
        
        .blob-3 { 
            width: 30vw;
            height: 30vw;
            max-width: 400px; max-height: 400px;
            background: radial-gradient(ellipse at center, var(--electric-pink) 0%, var(--holographic-purple) 50%, var(--neon-green) 100%);
            animation: floatMorph3 30s infinite alternate ease-in-out;
            opacity: 0.2;
            filter: blur(50px);
        }
        
        .blob-4 { 
            width: 40vw;
            height: 40vw;
            max-width: 500px; max-height: 500px;
            background: radial-gradient(circle at 50% 50%, var(--highlight-chrome) 5%, var(--chrome-silver) 30%, rgba(192,192,192,0.3) 60%, transparent 80%);
            animation: floatMorphHighlight 45s infinite alternate ease-in-out;
            opacity: 0.35;
            mix-blend-mode: lighten;
             filter: blur(30px);
        }


        @keyframes floatMorph1 {
            0% { transform: translate(-20vw, -20vh) scale(1) rotate(0deg); border-radius: 40% 60% 70% 30% / 30% 50% 50% 70%; }
            50% { transform: translate(30vw, 25vh) scale(1.3) rotate(180deg); border-radius: 60% 40% 30% 70% / 70% 30% 60% 40%; opacity: 0.35; }
            100% { transform: translate(-20vw, -20vh) scale(1) rotate(360deg); border-radius: 40% 60% 70% 30% / 30% 50% 50% 70%; }
        }

        @keyframes floatMorph2 {
            0% { transform: translate(60vw, 50vh) scale(1.2) rotate(45deg); border-radius: 70% 30% 40% 60% / 60% 40% 70% 30%; }
            50% { transform: translate(10vw, -10vh) scale(0.9) rotate(-90deg); border-radius: 30% 70% 60% 40% / 40% 60% 30% 70%; opacity: 0.2; }
            100% { transform: translate(60vw, 50vh) scale(1.2) rotate(45deg); border-radius: 70% 30% 40% 60% / 60% 40% 70% 30%; }
        }

        @keyframes floatMorph3 {
            0% { transform: translate(5vw, 60vh) scale(0.8) rotate(-30deg); border-radius: 50% 50% 30% 70% / 30% 70% 50% 50%; }
            50% { transform: translate(40vw, 10vh) scale(1.1) rotate(120deg); border-radius: 30% 70% 50% 50% / 50% 50% 70% 30%; opacity: 0.25; }
            100% { transform: translate(5vw, 60vh) scale(0.8) rotate(-30deg); border-radius: 50% 50% 30% 70% / 30% 70% 50% 50%; }
        }
        
        @keyframes floatMorphHighlight {
            0% { transform: translate(20vw, 10vh) scale(1) rotate(0deg); border-radius: 50%; opacity: 0.3; }
            33% { transform: translate(50vw, 40vh) scale(1.2) rotate(60deg); border-radius: 30% 70% 40% 60% / 60% 30% 70% 40%; opacity: 0.4; }
            66% { transform: translate(10vw, 70vh) scale(0.9) rotate(-30deg); border-radius: 70% 30% 60% 40% / 40% 70% 30% 70%; opacity: 0.35; }
            100% { transform: translate(20vw, 10vh) scale(1) rotate(0deg); border-radius: 50%; opacity: 0.3; }
        }


        /* Scanlines Overlay - ensure this is on top of blobs but behind content */
        body::after {
            content: "";
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: repeating-linear-gradient(
                transparent,
                transparent 2px,
                rgba(0, 0, 0, 0.15) 3px, 
                rgba(0, 0, 0, 0.15) 4px
            );
            pointer-events: none;
            z-index: -1; 
            opacity: 0.5; 
        }
        
        h1, h2, h3, h4, h5, h6 {
            font-family: 'Orbitron', sans-serif; 
            text-shadow: var(--text-glow-strong); 
            letter-spacing: 0.05em;
            color: var(--neon-green); 
        }
        h1 {
            font-size: 2.8rem; 
            color: var(--electric-pink); 
            text-shadow: 0 0 4px var(--electric-pink), 0 0 8px var(--electric-pink), 0 0 15px var(--cyber-blue), 0 0 20px var(--cyber-blue); 
            animation: textFlicker 4s infinite alternate; 
        }
        @keyframes textFlicker { 
            0%, 100% { text-shadow: 0 0 3px var(--electric-pink), 0 0 7px var(--electric-pink), 0 0 12px var(--cyber-blue), 0 0 18px var(--cyber-blue); opacity: 1; }
            50% { text-shadow: 0 0 2px var(--electric-pink), 0 0 4px var(--cyber-blue); opacity: 0.8; }
        }

        h2 {
            color: var(--cyber-blue); 
            text-shadow: var(--text-glow-medium);
        }
        p, label, span, div, li { 
             color: var(--neon-green);
        }
        .text-stone-600 { color: var(--chrome-silver) !important; opacity: 0.8; } 
        .text-stone-800, .text-stone-900 { color: var(--neon-green) !important; } 
        .text-stone-700 { color: var(--amber-glow) !important; } 
        .text-stone-500 { color: var(--chrome-silver) !important; opacity: 0.6; } 

        .bg-white { 
            background-color: rgba(10, 10, 10, 0.9) !important; 
            border: var(--border-neon);
            box-shadow: 0 0 10px rgba(0, 255, 65, 0.5), inset 0 0 8px rgba(0, 255, 65, 0.2); 
            backdrop-filter: blur(3px); 
            border-radius: 6px; 
        }
        .border-stone-200 { border-color: var(--neon-green) !important; opacity: 0.4; }
        .shadow-lg { box-shadow: 0 0 10px rgba(0, 255, 65, 0.5), 0 0 20px rgba(0, 255, 65, 0.3) !important; } 
        
        button, .button-like {
            font-family: 'Press Start 2P', cursive; 
            font-size: 0.7rem; 
            text-transform: uppercase;
            background: linear-gradient(145deg, var(--holographic-purple), var(--electric-pink));
            color: var(--terminal-black) !important; 
            border: 1px solid var(--electric-pink); 
            padding: 0.6rem 1.2rem; 
            border-radius: 3px; 
            box-shadow: 0 0 3px var(--electric-pink), 0 0 6px var(--electric-pink), inset 0 0 3px rgba(255, 255, 255, 0.2); 
            transition: all 0.15s ease-in-out;
        }
        button:hover, .button-like:hover {
            color: white !important; 
            background: linear-gradient(145deg, var(--electric-pink), var(--holographic-purple));
            box-shadow: 0 0 6px var(--holographic-purple), 0 0 12px var(--holographic-purple), inset 0 0 5px rgba(255, 255, 255, 0.3);
            transform: translateY(-1px) scale(1.01); 
        }
        button:disabled, .button-like:disabled {
            background: #222 !important; 
            color: #555 !important;
            border-color: #444 !important;
            box-shadow: none !important;
            opacity: 0.4;
        }
        .bg-blue-500 { background: linear-gradient(145deg, var(--cyber-blue), var(--holographic-purple)) !important; border-color: var(--cyber-blue) !important; box-shadow: 0 0 3px var(--cyber-blue), 0 0 6px var(--cyber-blue) !important; }
        .bg-blue-500:hover { background: linear-gradient(145deg, var(--holographic-purple), var(--cyber-blue)) !important; box-shadow: 0 0 6px var(--holographic-purple), 0 0 12px var(--holographic-purple) !important;}
        .bg-emerald-500 { background: linear-gradient(145deg, var(--neon-green), var(--cyber-blue)) !important; border-color: var(--neon-green) !important; box-shadow: 0 0 3px var(--neon-green), 0 0 6px var(--neon-green) !important; }
        .bg-emerald-500:hover { background: linear-gradient(145deg, var(--cyber-blue), var(--neon-green)) !important; box-shadow: 0 0 6px var(--cyber-blue), 0 0 12px var(--cyber-blue) !important;}
        .bg-sky-500 { background: linear-gradient(145deg, var(--cyber-blue), var(--electric-pink)) !important; border-color: var(--cyber-blue) !important; box-shadow: 0 0 3px var(--cyber-blue), 0 0 6px var(--cyber-blue) !important; }
        .bg-sky-500:hover { background: linear-gradient(145deg, var(--electric-pink), var(--cyber-blue)) !important; box-shadow: 0 0 6px var(--electric-pink), 0 0 12px var(--electric-pink) !important;}

        input[type=range].slider-track {
            background: rgba(0, 255, 65, 0.15); 
            border: 1px solid rgba(0, 255, 65, 0.5); 
            height: 8px; 
        }
        input[type=range]::-webkit-slider-thumb {
            background: var(--neon-green);
            border: 1px solid var(--terminal-black); 
            box-shadow: 0 0 6px var(--neon-green); 
            width: 18px; 
            height: 18px;
            margin-top: -6px; 
        }
        input[type=range]::-moz-range-thumb {
            background: var(--neon-green);
            border: 1px solid var(--terminal-black);
            box-shadow: 0 0 6px var(--neon-green);
            width: 18px;
            height: 18px;
        }
        input[type=range].bg-sky-100 { 
             background-color: rgba(0, 217, 255, 0.15) !important; 
             border: 1px solid rgba(0, 217, 255, 0.5) !important; 
        }
        input[type=range].bg-sky-100::-webkit-slider-thumb { background: var(--cyber-blue); box-shadow: 0 0 6px var(--cyber-blue); }
        input[type=range].bg-sky-100::-moz-range-thumb { background: var(--cyber-blue); box-shadow: 0 0 6px var(--cyber-blue); }
        
        textarea, input[type="text"] { 
            font-family: 'Fira Code', monospace;
            background-color: rgba(10, 10, 10, 0.8); 
            border: 1px solid var(--cyber-blue); 
            color: var(--cyber-blue);
            padding: 0.5rem;
            border-radius: 3px; 
            box-shadow: inset 0 0 5px rgba(0, 217, 255, 0.3); 
        }
        textarea:focus, input[type="text"]:focus {
            border-color: var(--electric-pink);
            box-shadow: inset 0 0 5px rgba(255, 0, 110, 0.4), 0 0 7px var(--electric-pink); 
        }
        ::placeholder { color: rgba(0, 217, 255, 0.4); } 

        .toggle-label {
            font-family: 'Press Start 2P', cursive;
            font-size: 0.65rem; 
            border: 1px solid var(--cyber-blue);
            color: var(--cyber-blue);
            padding: 0.5rem 0.7rem; 
        }
        .toggle-label.active {
            background-color: var(--cyber-blue);
            color: var(--terminal-black) !important; 
            text-shadow: none; 
            box-shadow: 0 0 7px var(--cyber-blue); 
        }

        .chart-container {
            border: var(--border-neon);
            padding: 0.8rem; 
            background: rgba(10,10,10,0.6); 
            box-shadow: inset 0 0 8px rgba(0,255,65,0.2); 
        }
        
        #intro-modal > div.bg-white, #ai-response-modal > div.bg-white { 
            background: repeating-linear-gradient(
                45deg,
                rgba(10,10,10,0.97), 
                rgba(10,10,10,0.97) 10px,
                rgba(12,0,12,0.97) 10px, 
                rgba(12,0,12,0.97) 20px
            ) !important; 
            border: 1px solid var(--holographic-purple); 
            box-shadow: 0 0 15px var(--holographic-purple), inset 0 0 10px rgba(138, 43, 226, 0.3); 
            color: var(--neon-green); 
            max-height: 85vh; 
            overflow-y: auto; 
        }
        #intro-modal > div.bg-white p, #intro-modal > div.bg-white li,
        #ai-response-modal > div.bg-white p, #ai-response-modal > div.bg-white li {
            color: var(--neon-green) !important; 
            text-shadow: 0 0 1px rgba(0, 255, 65, 0.4); 
        }
         #intro-modal > div.bg-white .text-stone-600 { 
            color: var(--chrome-silver) !important; 
            opacity: 0.8; 
        }

        #intro-modal h2, #ai-response-modal h2 { 
            color: var(--electric-pink) !important;
            text-shadow: var(--text-glow-pink);
        }
        #ai-response-modal #close-ai-response-modal-button {
            color: var(--electric-pink);
            font-size: 1.8rem; 
        }

        #consequences-log {
            border: 1px solid var(--cyber-blue); 
            padding: 0.4rem;
            background: rgba(10,10,10,0.8); 
            box-shadow: inset 0 0 6px rgba(0,217,255,0.2); 
        }
        #latest-impact-display {
            border: 1px dashed var(--amber-glow); 
            box-shadow: 0 0 7px var(--amber-glow); 
            background-color: rgba(255, 191, 0, 0.08); 
        }
        #latest-impact-display.decrease {
            border-color: var(--electric-pink);
            box-shadow: 0 0 7px var(--electric-pink);
            background-color: rgba(255, 0, 110, 0.08);
        }
        #latest-impact-display.increase { 
             border-color: var(--neon-green);
             box-shadow: 0 0 7px var(--neon-green);
             background-color: rgba(0, 255, 65, 0.08);
        }
        #latest-impact-display p, #consequences-log p {
            color: var(--chrome-silver) !important; 
        }
        #latest-impact-display .text-red-500, #consequences-log .text-red-500 { color: var(--electric-pink) !important; }
        #latest-impact-display .text-yellow-500, #consequences-log .text-yellow-500 { color: var(--amber-glow) !important; }
        #latest-impact-display .bg-red-50, #consequences-log .bg-red-50 { background-color: rgba(255,0,110,0.1) !important; border-color: rgba(255,0,110,0.3) !important; }
        #latest-impact-display .bg-yellow-50, #consequences-log .bg-yellow-50 { background-color: rgba(255,191,0,0.1) !important; border-color: rgba(255,191,0,0.3) !important; }

        #hover-tooltip {
            position: absolute; 
            background-color: rgba(10,10,10,0.95); 
            border: 1px solid var(--holographic-purple);
            color: var(--holographic-purple) !important; 
            box-shadow: 0 0 7px var(--holographic-purple); 
            font-size: 0.7rem; 
            padding: 0.4rem;
            z-index: 1001; 
            pointer-events: none; 
        }

        .info-icon {
            color: var(--cyber-blue);
            text-shadow: 0 0 3px var(--cyber-blue); 
        }
        .info-icon:hover {
            color: var(--electric-pink);
            text-shadow: 0 0 5px var(--electric-pink); 
            transform: scale(1.15); 
        }
        
        .ai-button svg {
            stroke-width: 2.2; 
        }

        #total-display {
            font-family: 'Orbitron', sans-serif;
            font-size: 1rem; 
            text-shadow: 0 0 3px currentColor; 
        }
        #total-display.bg-red-100 { background-color: rgba(255,0,110,0.2) !important; color: var(--electric-pink) !important; border: 1px solid var(--electric-pink); }
        #total-display.bg-green-100 { background-color: rgba(0,255,65,0.2) !important; color: var(--neon-green) !important; border: 1px solid var(--neon-green); }
        #total-display.bg-blue-100 { background-color: rgba(0,217,255,0.2) !important; color: var(--cyber-blue) !important; border: 1px solid var(--cyber-blue); }

        ::-webkit-scrollbar-thumb {
            background: var(--neon-green);
            box-shadow: inset 0 0 3px rgba(0,0,0,0.4); 
        }
        ::-webkit-scrollbar-thumb:hover {
            background: var(--electric-pink);
        }
        
        .main-category-header h3 { 
            color: var(--neon-green) !important; 
            text-shadow: var(--text-glow-strong);
        }
        .main-category-header span[id^="main-"][id$="-value"] { 
            color: var(--electric-pink) !important; 
            text-shadow: var(--text-glow-pink);
        }
        .main-category-header {
             border-bottom: 1px dashed rgba(0, 217, 255, 0.7) !important; 
             opacity: 0.85; 
        }

        .subcategory-sliders-container label {
            color: var(--cyber-blue) !important; 
            font-size: 0.85rem; 
        }
        .subcategory-sliders-container span[id^="sub_"][id$="-value"] {
            color: var(--amber-glow) !important; 
            text-shadow: 0 0 2px var(--amber-glow); 
        }
        
        .loader {
            border: 3px solid rgba(0, 255, 65, 0.15); 
            border-top: 3px solid var(--neon-green);
            width: 36px; 
            height: 36px;
        }

    </style>
</head>
<body> 
    <div class="blob-container">
        <div class="blob blob-1"></div>
        <div class="blob blob-2"></div>
        <div class="blob blob-3"></div>
        <div class="blob blob-4"></div>
    </div>
    <div id="app" class="container mx-auto p-4 md:p-8">

        <header class="text-center mb-8 md:mb-12">
            <h1 class="text-4xl md:text-5xl font-bold ">U.S. Federal Budget Simulator</h1>
            <p class="text-stone-600 mt-3 text-sm md:text-base max-w-3xl mx-auto">:: Adjust Allocations // Witness Consequences // Engage AI Oracle ::</p>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-5 gap-6 md:gap-8">
            
            <div class="lg:col-span-3 bg-white p-4 md:p-6 rounded-2xl shadow-lg border border-stone-200">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                    <h2 class="text-2xl font-bold">ALLOCATION INTERFACE</h2>
                    <div class="flex items-center gap-2">
                        <span class="text-sm font-medium text-stone-600">// MODE:</span>
                        <div id="allocation-mode-toggle" class="flex">
                            <input type="radio" id="mode-percentage" name="allocationMode" value="percentage" class="toggle-radio" checked>
                            <label for="mode-percentage" class="toggle-label active">%TOTAL</label>
                            <input type="radio" id="mode-dollars" name="allocationMode" value="dollars" class="toggle-radio">
                            <label for="mode-dollars" class="toggle-label">$USD</label>
                        </div>
                        <button id="reset-button" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition-colors ml-2 text-xs">RESET SYS</button>
                    </div>
                </div>
                <div id="sliders-and-categories-container" class="space-y-2">
                    </div>
            </div>

            <div class="lg:col-span-2 space-y-6 md:space-y-8">
                <div class="bg-white p-4 md:p-6 rounded-2xl shadow-lg border border-stone-200">
                    <h2 class="text-2xl font-bold text-center mb-4">BUDGET OVERVIEW</h2>
                    <div id="total-display" class="text-center mb-4 p-3 rounded-lg font-semibold text-lg"></div>
                    <div class="chart-container">
                        <canvas id="budgetChart"></canvas>
                    </div>
                </div>

                <div class="bg-white p-4 md:p-6 rounded-2xl shadow-lg border border-stone-200">
                    <h2 class="text-2xl font-bold mb-4">CONSEQUENCE LOG</h2>
                    <div id="consequences-log" class="space-y-3 h-64 md:h-72 overflow-y-auto pr-2 text-xs">
                        <p class="text-stone-500 italic">> SYSTEM BOOTED. AWAITING INPUT...</p>
                    </div>
                    <button id="generate-analysis-button" class="mt-4 w-full bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-3 px-4 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                        ANALYZE POLICY
                    </button>
                </div>

                <div class="bg-white p-4 md:p-6 rounded-2xl shadow-lg border border-stone-200">
                    <h2 class="text-2xl font-bold mb-3">AI ADVISOR</h2>
                    <p class="text-sm text-stone-600 mb-3">> Input query for resource allocation strategy:</p>
                    <textarea id="ai-advice-goal" rows="3" class="w-full p-2 border border-stone-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="> type your goal..."></textarea>
                    <button id="get-ai-advice-button" class="mt-3 w-full bg-sky-500 hover:bg-sky-600 text-white font-bold py-3 px-4 rounded-lg transition-colors">
                        QUERY AI
                    </button>
                </div>
            </div>
        </main>
    </div>
    
    <div id="latest-impact-display" class="text-stone-700">
        <p class="italic text-stone-500">> Standby for impact assessment...</p>
    </div>

    <div id="intro-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-2xl shadow-2xl p-6 md:p-8 max-w-lg w-full transform transition-all scale-100"> <h2 class="text-2xl font-bold mb-4 text-center">>> SYSTEM ONLINE: BUDGET SIMULATOR <<</h2>
            <p class="text-stone-600 mb-3">
                Welcome, Operator. Your mission: Reconfigure the U.S. Federal Budget. Manipulate subcategory funding streams via the provided interfaces. Mainframe categories will auto-calculate. Allocate by **%TOTAL_BUDGET** or **$USD_ABSOLUTE**. Target: **100%** or **TOTAL_BUDGET_TARGET**.
            </p>
             <p class="text-stone-600 mb-3">
                The **REALTIME_IMPACT_FEED** will materialize above the relevant sector upon adjustment. The **CONSEQUENCE_LOG** archives all fiscal alterations.
            </p>
            <p class="text-stone-600 mb-3">
                Access further data by mousing over [‚ÑπÔ∏è] data-nodes.
            </p>
            <p class="text-stone-600 mb-4">
                AI Subroutines Available:
                <ul class="list-disc list-inside text-sm text-stone-600 ml-4 space-y-1 font-mono">
                    <li>`ANALYZE POLICY`: AI deep-dive of current budget configuration.</li>
                    <li>`AI ADVISOR`: Request AI guidance for allocation objectives.</li>
                    <li>[üí°] (Lightbulb Icon): AI elaboration on specific consequence vector.</li>
                    <li>[üß†] (Brain Icon) (Post-Drastic Cut): AI proposal for alternative fiscal pathways.</li>
                </ul>
            </p>
            <button id="close-modal-button" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-lg transition-colors text-lg mt-2">INITIATE SIMULATION</button>
        </div>
    </div>

    <div id="ai-response-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-[60] hidden">
        <div class="bg-white rounded-2xl shadow-2xl p-6 sm:p-8 max-w-xl w-full"> <div class="flex justify-between items-center mb-4">
                <h2 id="ai-modal-title" class="text-2xl font-bold text-stone-900">AI RESPONSE</h2>
                <button id="close-ai-response-modal-button" class="text-stone-500 hover:text-stone-700 text-2xl">&times;</button>
            </div>
            <div id="ai-modal-content" class="modal-content text-stone-700 space-y-4 text-sm">
                </div>
        </div>
    </div>
    
    <div id="hover-tooltip" class="hidden"></div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const TOTAL_FEDERAL_BUDGET_USD = 6800000000000; 
            const SUB_CATEGORY_CONSEQUENCE_THRESHOLD_PERCENT_OF_TOTAL = 0.05; 

            const initialBudgetDataRaw = [ 
                { 
                    id: 'defense', name: 'National Defense', baselinePercent: 21, color: 'var(--neon-green)', 
                    description: 'Military, operations, equipment, research.',
                    hoverExplanation: 'Covers all aspects of the U.S. military including personnel salaries and benefits, weapons procurement, research and development of new technologies, and funding for ongoing military operations worldwide.',
                    consequences: { decrease: 'Reduced military readiness and slower modernization of equipment.', increase: 'Diverts significant funds from domestic priorities like healthcare and infrastructure.' },
                    subcategories: [
                        { id: 'personnel', name: 'Personnel', baselineShareOfParent: 40, hoverExplanation: "Salaries, benefits, housing, and support for active duty and reserve military members.", consequences: { decrease: "Potential recruitment/retention issues, reduced morale.", increase: "Higher personnel costs may limit funds for equipment or operations."} },
                        { id: 'operations_maintenance', name: 'Ops & Maintenance', baselineShareOfParent: 30, hoverExplanation: "Funding for training exercises, fuel, spare parts, base operations, and ongoing deployments.", consequences: { decrease: "Reduced training frequency, deferred maintenance, lower operational tempo.", increase: "Increased operational capacity, but could be underutilized if not strategically planned."} },
                        { id: 'procurement', name: 'Procurement', baselineShareOfParent: 20, hoverExplanation: "Acquisition of new military hardware such as aircraft, ships, ground vehicles, and weapon systems.", consequences: { decrease: "Delayed modernization, aging equipment, potential capability gaps.", increase: "Accelerated modernization, but risks cost overruns or acquiring unneeded systems."} },
                        { id: 'rdte', name: 'RDT&E', baselineShareOfParent: 10, hoverExplanation: "Investment in future military capabilities through research, development, testing, and evaluation of new technologies.", consequences: { decrease: "Slower technological advancement, risk of falling behind adversaries.", increase: "Potential for breakthrough technologies, but long lead times and uncertain outcomes."} }
                    ]
                },
                { 
                    id: 'healthcare', name: 'Healthcare', baselinePercent: 25, color: 'var(--electric-pink)', 
                    description: 'Medicare, Medicaid, public health.',
                    hoverExplanation: 'Funds federal health programs: Medicare, Medicaid, CHIP, and public health initiatives.',
                    consequences: { decrease: 'Reduced access to care for seniors and low-income families; less funding for medical research.', increase: 'May strain the national budget, requiring cuts in other essential services if not managed.' },
                    subcategories: [
                        { id: 'medicare', name: 'Medicare', baselineShareOfParent: 60, hoverExplanation: "Federal health insurance for seniors and some disabled individuals.", consequences: { decrease: "Higher out-of-pocket costs for seniors, reduced provider payments.", increase: "Improved benefits for seniors, but contributes to overall healthcare cost growth."}},
                        { id: 'medicaid_chip', name: 'Medicaid & CHIP', baselineShareOfParent: 30, hoverExplanation: "Health coverage for low-income individuals, families, and children.", consequences: { decrease: "Reduced eligibility or services for low-income populations.", increase: "Expanded coverage for vulnerable populations, but higher state/federal costs."}},
                        { id: 'public_health_research', name: 'Public Health/Research', baselineShareOfParent: 10, hoverExplanation: "Funds CDC, NIH biomedical research, mental health services.", consequences: { decrease: "Slower medical breakthroughs, reduced pandemic preparedness.", increase: "Accelerated medical innovation, better public health infrastructure." } }
                    ]
                },
                { 
                    id: 'social_security', name: 'Social Security', baselinePercent: 23, color: 'var(--amber-glow)', 
                    description: 'Retirement, disability, survivor benefits.',
                    hoverExplanation: 'Provides monthly benefits to retired workers, disabled individuals, and survivors.',
                    consequences: { decrease: 'Reduced benefits for current and future retirees.', increase: 'Requires higher taxes or deeper cuts elsewhere.' },
                    subcategories: [
                        { id: 'oasi', name: 'Retirement/Survivors (OASI)', baselineShareOfParent: 85, hoverExplanation: "Benefits for retired workers and survivors.", consequences: {decrease: "Lower monthly payments for retirees, potential increase in elderly poverty.", increase: "Enhanced financial security for retirees, but strains program solvency."}},
                        { id: 'di', name: 'Disability Ins. (DI)', baselineShareOfParent: 13, hoverExplanation: "Benefits for disabled workers.", consequences: {decrease: "Stricter eligibility or lower benefits for disabled individuals.", increase: "Improved support for the disabled, but potential for increased program enrollment."}},
                        { id: 'admin_ss', name: 'Admin Costs (SS)', baselineShareOfParent: 2, hoverExplanation: "Operational costs for the Social Security Administration.", consequences: {decrease: "Longer processing times, reduced customer service.", increase: "Improved efficiency and service."}}
                    ]
                },
                 { 
                    id: 'education', name: 'Education', baselinePercent: 4, color: 'var(--holographic-purple)', 
                    description: 'K-12, higher ed, student aid.',
                    hoverExplanation: 'Supports education from early childhood through postsecondary levels.',
                    consequences: { decrease: 'Larger class sizes, fewer resources for schools, and reduced access to higher education.', increase: 'Investment in the future, but requires trade-offs with immediate needs today.' },
                    subcategories: [
                        { id: 'k12_support', name: 'K-12 Support', baselineShareOfParent: 50, hoverExplanation: "Grants for K-12, Title I, special education.", consequences: {decrease: "Reduced funding for low-income schools, fewer teachers.", increase: "Improved resources for schools, potentially better student outcomes."}},
                        { id: 'higher_ed_aid', name: 'Higher Ed & Aid', baselineShareOfParent: 40, hoverExplanation: "Pell Grants, student loans, work-study.", consequences: {decrease: "Reduced Pell Grant amounts, higher student debt.", increase: "Increased access to college, lower student debt."}},
                        { id: 'early_childhood', name: 'Early Childhood Ed', baselineShareOfParent: 10, hoverExplanation: "Head Start, childcare assistance.", consequences: {decrease: "Fewer children in Head Start, reduced childcare access.", increase: "Improved early learning, better support for working families."}}
                    ]
                },
                { 
                    id: 'infrastructure', name: 'Infrastructure', baselinePercent: 5, color: 'var(--cyber-blue)', 
                    description: 'Transport, energy, water, broadband.',
                    hoverExplanation: 'Investments in physical infrastructure: highways, public transit, water systems, etc.',
                    consequences: { decrease: 'Deteriorating roads, bridges, and public transit.', increase: 'Boosts economy long-term, but requires significant upfront investment.' },
                    subcategories: [
                        { id: 'transportation_infra', name: 'Transportation', baselineShareOfParent: 60, hoverExplanation: "Highways, bridges, public transit, airports.", consequences: {decrease: "Worsening roads, increased congestion, less reliable transit.", increase: "Improved transportation networks, reduced travel times."}},
                        { id: 'water_utilities_infra', name: 'Water & Utilities', baselineShareOfParent: 25, hoverExplanation: "Drinking water systems, wastewater facilities, electric grid.", consequences: {decrease: "Increased risk of water contamination, power outages.", increase: "Safer drinking water, more reliable power grid."}},
                        { id: 'broadband_comm_infra', name: 'Broadband/Comm', baselineShareOfParent: 15, hoverExplanation: "Expand high-speed internet access.", consequences: {decrease: "Widening digital divide, limited online access.", increase: "Improved connectivity, economic opportunities."}}
                    ]
                },
                { 
                    id: 'environment', name: 'Environment/Energy', baselinePercent: 2, color: 'var(--neon-green)', 
                    description: 'Protection, conservation, clean energy.',
                    hoverExplanation: 'Funds EPA, conservation, clean energy development.',
                    consequences: { decrease: 'Weakened environmental protections, reduced renewable energy investment.', increase: 'Protects natural resources but may face industry opposition.' },
                     subcategories: [
                        { id: 'epa_regulation', name: 'EPA & Regulation', baselineShareOfParent: 40, hoverExplanation: "EPA funding for air/water quality, hazardous waste cleanup.", consequences: {decrease: "Increased pollution, less enforcement of environmental laws.", increase: "Cleaner air and water, but potential business compliance costs."}},
                        { id: 'conservation_resources', name: 'Conservation/Resources', baselineShareOfParent: 35, hoverExplanation: "Management of national parks, forests, wildlife refuges.", consequences: {decrease: "Degradation of public lands, loss of biodiversity.", increase: "Better protection of natural heritage, enhanced ecosystems."}},
                        { id: 'energy_dev_research', name: 'Energy Dev/Research', baselineShareOfParent: 25, hoverExplanation: "Investment in energy efficiency, renewables, nuclear research.", consequences: {decrease: "Slower clean energy transition, continued fossil fuel reliance.", increase: "Accelerated clean energy deployment, potential energy independence."}}
                    ]
                },
                { 
                    id: 'research', name: 'Science & Tech', baselinePercent: 3, color: 'var(--cyber-blue)', 
                    description: 'Scientific research, tech innovation.',
                    hoverExplanation: 'Supports NSF, NASA, DoE research programs.',
                    consequences: { decrease: 'Loss of competitive edge in science; slower progress.', increase: 'Fuels long-term innovation but takes from immediate programs.' },
                    subcategories: [
                        { id: 'nsf_general_science', name: 'General Science (NSF)', baselineShareOfParent: 40, hoverExplanation: "NSF funding for basic research and education.", consequences: {decrease: "Fewer grants for basic research, potential scientist brain drain.", increase: "More scientific discoveries, stronger STEM workforce."}},
                        { id: 'nasa_space', name: 'Space (NASA)', baselineShareOfParent: 35, hoverExplanation: "NASA space missions, aeronautics, scientific discovery.", consequences: {decrease: "Delayed space missions, reduced Earth observation.", increase: "Inspiring missions, technological spin-offs, but high cost."}},
                        { id: 'doe_applied_tech', name: 'Applied Tech (DOE)', baselineShareOfParent: 25, hoverExplanation: "DoE research, advanced computing, tech initiatives.", consequences: {decrease: "Slower new energy tech or advanced computing development.", increase: "Potential breakthroughs in key tech areas."}}
                    ]
                },
                { 
                    id: 'veterans', name: 'Veterans Affairs', baselinePercent: 5, color: 'var(--amber-glow)', 
                    description: 'Healthcare, benefits for veterans.',
                    hoverExplanation: 'Provides healthcare, disability, education benefits for veterans.',
                    consequences: { decrease: 'Reduced services and longer wait times for veterans.', increase: 'Fulfills national promise, but needs budget balance.' },
                    subcategories: [
                        { id: 'va_medical_care', name: 'VA Medical Care', baselineShareOfParent: 60, hoverExplanation: "VHA system: hospitals, clinics, mental health for veterans.", consequences: {decrease: "Longer wait times, reduced access to specialized care.", increase: "Improved healthcare access and quality for veterans."}},
                        { id: 'va_disability_pensions', name: 'VA Disability/Pensions', baselineShareOfParent: 25, hoverExplanation: "Financial support for service-disabled and low-income veterans.", consequences: {decrease: "Lower benefits or stricter eligibility for disabled veterans.", increase: "Better financial support for disabled veterans."}},
                        { id: 'va_education_other', name: 'VA Ed & Support', baselineShareOfParent: 15, hoverExplanation: "GI Bill, vocational rehab, housing assistance, burial benefits.", consequences: {decrease: "Reduced GI Bill benefits, fewer resources for veteran job training.", increase: "Enhanced opportunities for veterans transitioning to civilian life."}}
                    ]
                },
                { 
                    id: 'other', name: 'Other Services', baselinePercent: 12, color: 'var(--chrome-silver)', 
                    description: 'Agriculture, justice, foreign aid, etc.',
                    hoverExplanation: 'Agriculture, justice system, foreign aid, government operations.',
                    consequences: { decrease: 'Reduced capacity in law enforcement, diplomacy, food safety.', increase: 'Strengthens various functions, but can be seen as less critical.' },
                    subcategories: [
                        { id: 'justice_law', name: 'Justice/Law Enf.', baselineShareOfParent: 30, hoverExplanation: "Federal courts, DoJ (FBI, DEA), federal prisons.", consequences: {decrease: "Reduced FBI/DEA capacity, slower courts, underfunded prisons.", increase: "Strengthened federal law enforcement, improved court efficiency."}},
                        { id: 'agriculture_rural', name: 'Agric./Rural Dev.', baselineShareOfParent: 25, hoverExplanation: "Farm income support, food safety, agricultural research.", consequences: {decrease: "Reduced farm subsidies, potential impact on food prices.", increase: "Stronger farmer support, improved food safety, but can distort markets."}},
                        { id: 'international_affairs', name: 'Intl. Affairs/Aid', baselineShareOfParent: 25, hoverExplanation: "State Dept, diplomatic missions, foreign aid.", consequences: {decrease: "Weakened diplomatic influence, reduced humanitarian aid.", increase: "Stronger global partnerships, enhanced soft power."}},
                        { id: 'general_gov_other', name: 'General Gov./Other', baselineShareOfParent: 20, hoverExplanation: "IRS, GSA, legislative branch operations, smaller agencies.", consequences: {decrease: "Reduced IRS enforcement, inefficient government operations.", increase: "Improved government efficiency, better tax collection."}}
                    ]
                },
            ];
            
            function getComputedColor(cssVarString) {
                if (cssVarString && typeof cssVarString === 'string' && cssVarString.startsWith('var(')) {
                    const varName = cssVarString.substring(4, cssVarString.length - 1);
                    try {
                        const color = getComputedStyle(document.documentElement).getPropertyValue(varName.trim()).trim();
                        return color || cssVarString; 
                    } catch (e) {
                        console.warn(`Could not compute CSS variable: ${cssVarString}`, e);
                        return cssVarString; 
                    }
                }
                return cssVarString; 
            }


            function processInitialData(rawData) {
                const processedData = [];
                rawData.forEach(mainCatRaw => {
                    const mainCategory = {
                        id: mainCatRaw.id,
                        name: mainCatRaw.name,
                        description: mainCatRaw.description,
                        hoverExplanation: mainCatRaw.hoverExplanation,
                        color: mainCatRaw.color, 
                        subcategories: [],
                        valuePercent: 0, 
                        valueUSD: 0      
                    };

                    if (mainCatRaw.subcategories) {
                        let sumOfBaselineShares = mainCatRaw.subcategories.reduce((sum, sub) => sum + sub.baselineShareOfParent, 0);
                        mainCatRaw.subcategories.forEach(subRaw => {
                            let normalizedBaselineShareOfParent = subRaw.baselineShareOfParent;
                            if (sumOfBaselineShares !== 100 && sumOfBaselineShares > 0) {
                                normalizedBaselineShareOfParent = (subRaw.baselineShareOfParent / sumOfBaselineShares) * 100;
                            } else if (sumOfBaselineShares === 0 && mainCatRaw.subcategories.length > 0) {
                                normalizedBaselineShareOfParent = 100 / mainCatRaw.subcategories.length;
                            }

                            const baselinePercentOfTotal = (mainCatRaw.baselinePercent * normalizedBaselineShareOfParent) / 100;
                            const subCategory = {
                                ...subRaw, 
                                parentId: mainCatRaw.id,
                                parentName: mainCatRaw.name,
                                valuePercent: baselinePercentOfTotal, 
                                valueUSD: (baselinePercentOfTotal / 100) * TOTAL_FEDERAL_BUDGET_USD,
                                originalBaselinePercent: baselinePercentOfTotal, 
                            };
                            mainCategory.subcategories.push(subCategory);
                            mainCategory.valuePercent += subCategory.valuePercent;
                            mainCategory.valueUSD += subCategory.valueUSD;
                        });
                    }
                    processedData.push(mainCategory);
                });
                return processedData;
            }
            
            let budgetData = processInitialData(initialBudgetDataRaw);
            let currentSliderBaselines = {}; 
            let allocationMode = 'percentage'; 

            let chart;
            const slidersAndCategoriesContainer = document.getElementById('sliders-and-categories-container');
            const totalDisplay = document.getElementById('total-display');
            const consequencesLog = document.getElementById('consequences-log');
            const latestImpactDisplay = document.getElementById('latest-impact-display'); 
            const resetButton = document.getElementById('reset-button');
            const introModal = document.getElementById('intro-modal');
            const closeModalButton = document.getElementById('close-modal-button');
            const allocationModeToggle = document.getElementById('allocation-mode-toggle');
            const hoverTooltip = document.getElementById('hover-tooltip');
            
            const generateAnalysisButton = document.getElementById('generate-analysis-button');
            const aiAdviceGoalInput = document.getElementById('ai-advice-goal');
            const getAIAdviceButton = document.getElementById('get-ai-advice-button');
            
            const aiResponseModal = document.getElementById('ai-response-modal');
            const aiModalTitle = document.getElementById('ai-modal-title');
            const aiModalContent = document.getElementById('ai-modal-content');
            const closeAIResponseModalButton = document.getElementById('close-ai-response-modal-button');

            function formatCurrency(value) {
                if (value >= 1e12) { return `$${(value / 1e12).toFixed(2)}T`; }
                if (value >= 1e9) { return `$${(value / 1e9).toFixed(1)}B`; }
                if (value >= 1e6) { return `$${(value / 1e6).toFixed(0)}M`; }
                return `$${value.toLocaleString()}`;
            }

            function storeCurrentBaselinesForConsequences() {
                currentSliderBaselines = {}; 
                budgetData.forEach(mainItem => {
                    if (mainItem.subcategories) {
                        mainItem.subcategories.forEach(subItem => {
                            const sliderId = `sub_${mainItem.id}_${subItem.id}`;
                            currentSliderBaselines[sliderId] = allocationMode === 'percentage' ? subItem.valuePercent : subItem.valueUSD;
                        });
                    }
                });
            }

            function createSliders() {
                slidersAndCategoriesContainer.innerHTML = ''; 
                
                budgetData.forEach(mainItem => {
                    const mainCategorySection = document.createElement('div');
                    mainCategorySection.id = `main-category-section-${mainItem.id}`;
                    mainCategorySection.classList.add('mb-6'); 

                    const headerDiv = document.createElement('div');
                    headerDiv.classList.add('flex', 'justify-between', 'items-center', 'mb-1', 'main-category-header');
                    headerDiv.innerHTML = `
                        <div class="flex items-center">
                            <h3 class="font-bold text-xl">${mainItem.name}</h3>
                            <span class="info-icon" data-tooltip-text="${mainItem.hoverExplanation || mainItem.description}">‚ÑπÔ∏è</span>
                        </div>
                        <span id="main-${mainItem.id}-value" class="font-bold text-xl">
                            ${allocationMode === 'percentage' ? mainItem.valuePercent.toFixed(1) + '%' : formatCurrency(mainItem.valueUSD)}
                        </span>
                    `;
                    mainCategorySection.appendChild(headerDiv);

                    const subcategoriesContainer = document.createElement('div');
                    subcategoriesContainer.classList.add('subcategory-sliders-container', 'space-y-5');
                    
                    if (mainItem.subcategories) {
                        mainItem.subcategories.forEach(subItem => {
                            const subSliderWrapper = document.createElement('div');
                            const sliderId = `sub_${mainItem.id}_${subItem.id}`;
                            
                            let subDisplayValue, subSliderValue, subSliderMin, subSliderMax, subSliderStep;

                            if (allocationMode === 'percentage') { 
                                subDisplayValue = `${subItem.valuePercent.toFixed(1)}%`;
                                subSliderValue = subItem.valuePercent;
                                subSliderMin = 0; subSliderMax = 30; 
                                subSliderStep = 0.1;
                            } else { 
                                subDisplayValue = formatCurrency(subItem.valueUSD);
                                subSliderValue = subItem.valueUSD;
                                subSliderMin = 0; subSliderMax = TOTAL_FEDERAL_BUDGET_USD * 0.30; 
                                subSliderStep = 1000000000; 
                            }

                            let subSliderTrackClass = 'slider-track'; 
                            if (mainItem.id === 'healthcare' || mainItem.id === 'education' || mainItem.id === 'research' || mainItem.id === 'infrastructure') { 
                                subSliderTrackClass += ' bg-sky-100'; 
                            }


                            subSliderWrapper.innerHTML = `
                                <div class="flex justify-between items-center mb-1">
                                    <div class="flex items-center">
                                        <label for="${sliderId}" class="font-medium text-md">${subItem.name}</label>
                                        <span class="info-icon" data-tooltip-text="${subItem.hoverExplanation || subItem.name}">‚ÑπÔ∏è</span>
                                    </div>
                                    <span id="${sliderId}-value" class="font-semibold text-md">${subDisplayValue}</span>
                                </div>
                                <input type="range" id="${sliderId}" data-parent-id="${mainItem.id}" data-sub-id="${subItem.id}" 
                                       min="${subSliderMin}" max="${subSliderMax}" value="${subSliderValue}" step="${subSliderStep}" 
                                       class="w-full h-2 rounded-lg appearance-none cursor-pointer ${subSliderTrackClass}">
                            `; 
                            subcategoriesContainer.appendChild(subSliderWrapper);
                        });
                    }
                    mainCategorySection.appendChild(subcategoriesContainer);
                    slidersAndCategoriesContainer.appendChild(mainCategorySection);
                });
                storeCurrentBaselinesForConsequences(); 
                addEventListenersToSlidersAndButtons();
            }
            
            function updateAll(changedSliderId = null) {
                let overallTotalPercent = 0;
                let overallTotalUSD = 0;

                budgetData.forEach(mainItem => {
                    let mainCatTotalPercent = 0;
                    let mainCatTotalUSD = 0;

                    if (mainItem.subcategories) {
                        mainItem.subcategories.forEach(subItem => {
                            const sliderId = `sub_${mainItem.id}_${subItem.id}`;
                            const subSlider = document.getElementById(sliderId);

                            if (subSlider) { 
                                if (!changedSliderId || changedSliderId === sliderId) { 
                                    const sliderValue = parseFloat(subSlider.value);
                                    if (allocationMode === 'percentage') {
                                        subItem.valuePercent = sliderValue; 
                                        subItem.valueUSD = (sliderValue / 100) * TOTAL_FEDERAL_BUDGET_USD;
                                    } else { 
                                        subItem.valueUSD = sliderValue;
                                        subItem.valuePercent = (sliderValue / TOTAL_FEDERAL_BUDGET_USD) * 100;
                                    }
                                }
                            }
                            mainCatTotalPercent += subItem.valuePercent;
                            mainCatTotalUSD += subItem.valueUSD;

                            const subValueDisplay = document.getElementById(`${sliderId}-value`);
                            if (subValueDisplay) {
                                if (allocationMode === 'percentage') {
                                    subValueDisplay.textContent = `${subItem.valuePercent.toFixed(1)}%`;
                                } else {
                                    subValueDisplay.textContent = formatCurrency(subItem.valueUSD);
                                }
                            }
                        });
                    }

                    mainItem.valuePercent = mainCatTotalPercent;
                    mainItem.valueUSD = mainCatTotalUSD;

                    const mainValueDisplay = document.getElementById(`main-${mainItem.id}-value`);
                    if (mainValueDisplay) {
                         if (allocationMode === 'percentage') {
                            mainValueDisplay.innerHTML = `${mainItem.valuePercent.toFixed(1)}% <span class='text-xs opacity-70'>(${formatCurrency(mainItem.valueUSD)})</span>`;
                        } else {
                            mainValueDisplay.innerHTML = `${formatCurrency(mainItem.valueUSD)} <span class='text-xs opacity-70'>(${mainItem.valuePercent.toFixed(1)}%)</span>`;
                        }
                    }
                    overallTotalPercent += mainItem.valuePercent;
                    overallTotalUSD += mainItem.valueUSD;
                });
            
                if (allocationMode === 'percentage') {
                    totalDisplay.textContent = `TOTAL: ${overallTotalPercent.toFixed(1)}% / 100%`;
                    generateAnalysisButton.disabled = !(overallTotalPercent >= 95 && overallTotalPercent <= 105);
                    if (overallTotalPercent > 100.05) {
                        totalDisplay.className = 'text-center mb-4 p-3 rounded-lg font-semibold text-lg bg-red-100'; 
                    } else if (Math.abs(overallTotalPercent - 100) < 0.05) {
                        totalDisplay.className = 'text-center mb-4 p-3 rounded-lg font-semibold text-lg bg-green-100';
                    } else {
                        totalDisplay.className = 'text-center mb-4 p-3 rounded-lg font-semibold text-lg bg-blue-100';
                    }
                } else { 
                    totalDisplay.textContent = `TOTAL: ${formatCurrency(overallTotalUSD)} / ${formatCurrency(TOTAL_FEDERAL_BUDGET_USD)}`;
                    const fivePercentOfTotalBudget = TOTAL_FEDERAL_BUDGET_USD * 0.05;
                    generateAnalysisButton.disabled = !(overallTotalUSD >= TOTAL_FEDERAL_BUDGET_USD - fivePercentOfTotalBudget && overallTotalUSD <= TOTAL_FEDERAL_BUDGET_USD + fivePercentOfTotalBudget);
                     if (overallTotalUSD > TOTAL_FEDERAL_BUDGET_USD + (TOTAL_FEDERAL_BUDGET_USD * 0.0005) ) { 
                        totalDisplay.className = 'text-center mb-4 p-3 rounded-lg font-semibold text-lg bg-red-100';
                    } else if (Math.abs(overallTotalUSD - TOTAL_FEDERAL_BUDGET_USD) < (TOTAL_FEDERAL_BUDGET_USD * 0.0005) ) { 
                        totalDisplay.className = 'text-center mb-4 p-3 rounded-lg font-semibold text-lg bg-green-100';
                    } else {
                        totalDisplay.className = 'text-center mb-4 p-3 rounded-lg font-semibold text-lg bg-blue-100';
                    }
                }
                updateChart();
            }

            function updateChart() { 
                if (!chart) return;
                const activeBudgetData = budgetData.filter(item => item.valuePercent > 0);
                chart.data.labels = activeBudgetData.map(item => item.name);
                chart.data.datasets[0].data = activeBudgetData.map(item => item.valuePercent);
                chart.data.datasets[0].backgroundColor = activeBudgetData.map(item => getComputedColor(item.color));
                
                chart.options.plugins.tooltip.callbacks.label = function(context) {
                    let label = context.label || '';
                    if (label) { label += ': '; }
                    const currentMainItem = budgetData.find(d => d.name === context.label);
                    if (currentMainItem) {
                        label += `${currentMainItem.valuePercent.toFixed(1)}% (${formatCurrency(currentMainItem.valueUSD)})`;
                    } else { 
                         label += `${context.parsed.toFixed(1)}% (Data error)`;
                    }
                    return label;
                };
                chart.update();
            }
            
            function logConsequence(subItem, changeType, parentItemName) { 
                const logEntry = document.createElement('div');
                logEntry.classList.add('p-2', 'rounded', 'flex', 'items-start', 'gap-2', 'transition-all', 'transform', 'scale-95', 'opacity-0', 'mb-1');
                
                let iconHtml = '';
                let consequenceText = '';
                let isDrasticCut = false; 
                let displayName = `${parentItemName} (${subItem.name})`; 
                
                if (changeType === 'decrease') {
                    logEntry.classList.add('bg-red-50'); 
                    iconHtml = `<span class="text-red-500 text-lg font-bold mt-[-2px]">‚ñº</span>`; 
                    consequenceText = `CUT ${displayName}: ${subItem.consequences.decrease}`;
                    if (subItem.valuePercent < subItem.originalBaselinePercent * 0.5) { 
                        isDrasticCut = true;
                    }
                    latestImpactDisplay.className = 'p-3 mb-4 rounded-lg text-stone-700 decrease';
                } else { 
                    logEntry.classList.add('bg-yellow-50'); 
                    iconHtml = `<span class="text-yellow-500 text-lg font-bold mt-[-2px]">‚ñ≤</span>`; 
                    consequenceText = `BOOST ${displayName}: ${subItem.consequences.increase}`;
                    latestImpactDisplay.className = 'p-3 mb-4 rounded-lg text-stone-700 increase';
                }
                
                const uniqueIdPart = `${subItem.parentId}_${subItem.id}`; 
                const explainButtonId = `explain-${uniqueIdPart}-${Date.now()}`;
                let buttonsHtml = `
                    <button id="${explainButtonId}" title="Explain with AI" class="ai-button text-sky-500">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2.75a4.25 4.25 0 0 0-4.25 4.25c0 2.65 1.95 4.25 4.25 4.25s4.25-1.6 4.25-4.25A4.25 4.25 0 0 0 12 2.75Z"/><path d="M12 11.25S8.75 13.25 8.75 16H12v5.25S15.25 18.75 15.25 16h-3.25Z"/></svg>
                    </button>
                `;

                let suggestAlternativesButtonId = '';
                if (isDrasticCut) { 
                    suggestAlternativesButtonId = `suggest-alt-${uniqueIdPart}-${Date.now()}`;
                    buttonsHtml += `
                        <button id="${suggestAlternativesButtonId}" title="Suggest Alternative Solutions" class="ai-button text-orange-500 ml-1">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2a10 10 0 0 0-6.93 17.07A10 10 0 0 0 12 22a10 10 0 0 0 6.93-2.93A10 10 0 0 0 12 2Z"/><path d="M12 10a2.5 2.5 0 0 0-2.5 2.5c0 .83.42 1.57 1.09 2.02"/><path d="M12 10a2.5 2.5 0 0 1 2.5 2.5c0 .83-.42 1.57-1.09 2.02"/><path d="M14.5 9.04A2.5 2.5 0 0 0 12 7.5a2.5 2.5 0 0 0-2.5 1.54"/><path d="M9.5 9.04A2.5 2.5 0 0 1 12 7.5a2.5 2.5 0 0 1 2.5 1.54"/><path d="M12 14.5a2.5 2.5 0 0 1 2.5-2.5c.83 0 1.57.42 2.02 1.09"/><path d="M12 14.5a2.5 2.5 0 0 0-2.5-2.5c-.83 0-1.57.42-2.02 1.09"/></svg>
                        </button>
                    `;
                }
                
                const fullEntryHtml = `
                    ${iconHtml} 
                    <p class="text-stone-700 text-xs flex-grow">${consequenceText.replace(/<strong>(.*?)<\/strong>/g, '<span class="font-semibold">$1</span>')}</p>
                    <div class="flex items-center flex-shrink-0">${buttonsHtml}</div>`;
                
                logEntry.innerHTML = fullEntryHtml;
                latestImpactDisplay.innerHTML = `<p>${fullEntryHtml}</p>`; 

                const firstChild = consequencesLog.firstChild;
                if (firstChild && firstChild.nodeName === 'P' && firstChild.classList.contains('italic')) { 
                    consequencesLog.innerHTML = '';
                }
                consequencesLog.prepend(logEntry);
                consequencesLog.scrollTop = 0; 
                
                document.getElementById(explainButtonId).addEventListener('click', () => handleExplainConsequence(consequenceText));
                if (isDrasticCut && suggestAlternativesButtonId) {
                    document.getElementById(suggestAlternativesButtonId).addEventListener('click', () => handleSuggestAlternatives(subItem.name, parentItemName, consequenceText));
                }

                setTimeout(() => {
                    logEntry.classList.remove('scale-95', 'opacity-0');
                    logEntry.classList.add('scale-100', 'opacity-100');
                }, 10);
            }

            function initChart() {
                const ctx = document.getElementById('budgetChart').getContext('2d');
                
                Chart.defaults.font.family = "'Fira Code', monospace";
                Chart.defaults.color = getComputedColor('var(--neon-green)'); 

                Chart.defaults.scale = { 
                    grid: {
                        color: getComputedColor('rgba(0, 255, 65, 0.2)'), 
                        borderColor: getComputedColor('var(--neon-green)') 
                    },
                    ticks: {
                        color: getComputedColor('var(--neon-green)') 
                    },
                    angleLines: { 
                        color: getComputedColor('rgba(0, 255, 65, 0.2)')
                    },
                    pointLabels: { 
                         color: getComputedColor('var(--neon-green)')
                    }
                };

                chart = new Chart(ctx, {
                    type: 'doughnut',
                    data: { 
                        labels: budgetData.map(item => item.name),
                        datasets: [{
                            data: budgetData.map(item => item.valuePercent), 
                            backgroundColor: budgetData.map(item => getComputedColor(item.color)), 
                            borderColor: getComputedColor('var(--terminal-black)'), 
                            borderWidth: 3,
                            hoverBorderColor: getComputedColor('var(--electric-pink)'),
                            hoverBorderWidth: 4,
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { 
                                position: 'bottom', 
                                labels: { 
                                    padding: 15, 
                                    color: getComputedColor('var(--cyber-blue)'), 
                                    font: { size: 10, family: "'Press Start 2P', cursive" }
                                }
                            },
                            tooltip: { 
                                enabled: true,
                                backgroundColor: getComputedColor('rgba(10,10,10,0.9)'),
                                titleColor: getComputedColor('var(--electric-pink)'),
                                titleFont: { family: "'Orbitron', sans-serif", size: 14, weight: 'bold'},
                                bodyColor: getComputedColor('var(--neon-green)'),
                                bodyFont: { family: "'Fira Code', monospace", size: 12 },
                                padding: 10,
                                cornerRadius: 0,
                                borderColor: getComputedColor('var(--electric-pink)'),
                                borderWidth: 1,
                                displayColors: true,
                                boxPadding: 5,
                                callbacks: { 
                                    label: (c) => `${c.label || ''}: ${c.parsed || 0}%` 
                                }
                            } 
                        },
                        cutout: '65%', 
                    }
                });
            }

            function handleSliderInteraction(event) {
                const sliderId = event.target.id; 
                const parentId = event.target.dataset.parentId;
                const subId = event.target.dataset.subId;

                const mainItem = budgetData.find(d => d.id === parentId);
                const subItem = mainItem ? mainItem.subcategories.find(s => s.id === subId) : null;
                if (!subItem || !mainItem) return;

                const targetCategorySection = document.getElementById(`main-category-section-${mainItem.id}`);
                if (targetCategorySection && latestImpactDisplay.parentNode !== slidersAndCategoriesContainer) {
                    slidersAndCategoriesContainer.prepend(latestImpactDisplay); 
                }
                 if (targetCategorySection) { 
                    targetCategorySection.before(latestImpactDisplay); 
                }

                const newValueRaw = parseFloat(event.target.value); 
                const previousBaselineValueForSlider = currentSliderBaselines[sliderId]; 

                let currentComparisonValuePercentOfTotal; 
                let previousComparisonValuePercentOfTotal;

                if (allocationMode === 'percentage') {
                    currentComparisonValuePercentOfTotal = newValueRaw; 
                    previousComparisonValuePercentOfTotal = previousBaselineValueForSlider;
                } else { 
                    currentComparisonValuePercentOfTotal = (newValueRaw / TOTAL_FEDERAL_BUDGET_USD) * 100; 
                    previousComparisonValuePercentOfTotal = (previousBaselineValueForSlider / TOTAL_FEDERAL_BUDGET_USD) * 100;
                }
                
                if (Math.abs(currentComparisonValuePercentOfTotal - previousComparisonValuePercentOfTotal) >= SUB_CATEGORY_CONSEQUENCE_THRESHOLD_PERCENT_OF_TOTAL) {
                    if (currentComparisonValuePercentOfTotal < previousComparisonValuePercentOfTotal) {
                        logConsequence(subItem, 'decrease', mainItem.name);
                    } else if (currentComparisonValuePercentOfTotal > previousComparisonValuePercentOfTotal) {
                        logConsequence(subItem, 'increase', mainItem.name);
                    }
                }
                currentSliderBaselines[sliderId] = newValueRaw; 
                updateAll(sliderId); 
            }
            
            function resetApp() {
                allocationMode = 'percentage'; 
                document.getElementById('mode-percentage').checked = true;
                document.getElementById('mode-dollars').checked = false;
                updateToggleLabels();

                budgetData = processInitialData(initialBudgetDataRaw); 
                createSliders(); 
                updateAll(); 

                consequencesLog.innerHTML = `<p class="text-stone-500 italic">> SYSTEM BOOTED. AWAITING INPUT...</p>`;
                latestImpactDisplay.innerHTML = `<p class="italic text-stone-500">> Standby for impact assessment...</p>`;
                latestImpactDisplay.className = 'p-3 mb-4 rounded-lg text-stone-700'; 
                const firstCategorySection = slidersAndCategoriesContainer.firstChild;
                if (firstCategorySection) {
                    firstCategorySection.before(latestImpactDisplay);
                } else { 
                    slidersAndCategoriesContainer.prepend(latestImpactDisplay);
                }

                generateAnalysisButton.disabled = true;
                aiAdviceGoalInput.value = '';
            }

            function addEventListenersToSlidersAndButtons() {
                 document.querySelectorAll('input[type="range"]').forEach(slider => {
                    slider.addEventListener('input', (event) => updateAll(event.target.id)); 
                    slider.addEventListener('change', handleSliderInteraction); 
                 });
                 document.querySelectorAll('.info-icon').forEach(icon => {
                    icon.addEventListener('mouseover', showTooltip);
                    icon.addEventListener('mouseout', hideTooltip);
                    icon.addEventListener('mousemove', moveTooltip);
                 });
            }

            function showTooltip(event) {
                const text = event.target.dataset.tooltipText;
                if (!text) return;
                hoverTooltip.innerHTML = text;
                hoverTooltip.classList.remove('hidden');
                if (hoverTooltip.parentNode !== document.body) {
                    document.body.appendChild(hoverTooltip);
                }
                moveTooltip(event); 
            }

            function hideTooltip() {
                hoverTooltip.classList.add('hidden');
            }

            function moveTooltip(event) {
                if (!hoverTooltip.classList.contains('hidden')) {
                    let x = event.clientX + 15; 
                    let y = event.clientY + 15 + window.scrollY; 

                    const tooltipRect = hoverTooltip.getBoundingClientRect(); 
                    const viewportWidth = window.innerWidth;
                    const viewportHeight = window.innerHeight; 

                    if (event.clientX + 15 + tooltipRect.width > viewportWidth) {
                        x = event.clientX - tooltipRect.width - 15;
                    }
                    if (event.clientY + 15 + tooltipRect.height > viewportHeight) {
                         y = event.clientY - tooltipRect.height - 15 + window.scrollY;
                    }

                    if (event.clientX - tooltipRect.width - 15 < 0 && x < event.clientX + 15) { 
                         x = event.clientX + 15; 
                    }
                    if (event.clientY - tooltipRect.height - 15 < 0 && y < event.clientY + 15 + window.scrollY) {
                        y = event.clientY + 15 + window.scrollY; 
                    }

                    hoverTooltip.style.left = `${x}px`;
                    hoverTooltip.style.top = `${y}px`;
                }
            }
            
            function updateToggleLabels() {
                document.querySelectorAll('#allocation-mode-toggle label').forEach(label => {
                    if (label.getAttribute('for') === `mode-${allocationMode}`) {
                        label.classList.add('active');
                    } else {
                        label.classList.remove('active');
                    }
                });
            }

            allocationModeToggle.addEventListener('change', (event) => {
                allocationMode = event.target.value;
                updateToggleLabels();
                createSliders(); 
                updateAll(); 
            });

            async function callGeminiAPI(prompt) {
                aiModalContent.innerHTML = '<div class="loader"></div> <p class="text-center text-stone-600 blink">AI_PROCESSING_REQUEST...</p>';
                aiResponseModal.classList.remove('hidden');
                
                let chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
                const payload = { contents: chatHistory };
                const apiKey = ""; 
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(`API Error (${response.status}): ${errorData.error?.message || 'Unknown error // TRANSMISSION_FAILURE'}`);
                    }
                    const result = await response.json();
                    
                    if (result.candidates && result.candidates.length > 0 &&
                        result.candidates[0].content && result.candidates[0].content.parts &&
                        result.candidates[0].content.parts.length > 0) {
                        const text = result.candidates[0].content.parts[0].text;
                        let htmlContent = text.replace(/\*\*(.*?)\*\*/g, '<strong class="text-electric-pink">$1</strong>'); 
                        htmlContent = htmlContent.split('\n\n').map(p => `<p class="mb-2">${p.replace(/\n/g, '<br>')}</p>`).join(''); 
                        aiModalContent.innerHTML = htmlContent;
                    } else {
                        aiModalContent.innerHTML = '<p class="text-red-600">> CRITICAL_ERROR: AI response malformed. Expected structure not found.</p>';
                        console.error("Unexpected API response structure:", result);
                    }
                } catch (error) {
                    console.error('Error calling Gemini API:', error);
                    aiModalContent.innerHTML = `<p class="text-red-600">> ERROR: ${error.message}. AI_LINK_SEVERED. Retry later.</p>`;
                }
            }
            
            function getBudgetStringForAI() {
                let summary = [];
                const overallTotalPercent = budgetData.reduce((sum, item) => sum + item.valuePercent, 0);
                const overallTotalUSD = budgetData.reduce((sum, item) => sum + item.valueUSD, 0);

                summary.push(`SYSTEM_STATE: Overall Budget Allocation: ${overallTotalPercent.toFixed(1)}% (${formatCurrency(overallTotalUSD)} / ${formatCurrency(TOTAL_FEDERAL_BUDGET_USD)} target).\n`);

                budgetData.forEach(mainItem => {
                    summary.push(`SECTOR: ${mainItem.name} (Total: ${mainItem.valuePercent.toFixed(1)}% / ${formatCurrency(mainItem.valueUSD)}):`);
                    if (mainItem.subcategories) {
                        mainItem.subcategories.forEach(sub => {
                            summary.push(`  - NODE: ${sub.name}: ${sub.valuePercent.toFixed(1)}% of total budget (${formatCurrency(sub.valueUSD)})`);
                        });
                    }
                });
                return summary.join('\n');
            }

            async function handleGenerateOverallAnalysis() {
                aiModalTitle.textContent = 'AI POLICY ANALYSIS';
                const budgetSummary = getBudgetStringForAI();
                const prompt = `Analyze potential broader societal/economic impacts of the U.S. federal budget configuration below. Focus on trade-offs, interconnectedness, main category totals, and impactful subcategory allocations. Output: 3-4 concise paragraphs. Format for a retro-futuristic terminal display.\n\n${budgetSummary}`;
                await callGeminiAPI(prompt);
            }

            async function handleGetAIAdvice() {
                const userGoal = aiAdviceGoalInput.value.trim();
                if (!userGoal) {
                    aiModalTitle.textContent = 'INPUT ERROR';
                    aiModalContent.innerHTML = '<p class="text-amber-glow">> Directive required. Specify allocation goal in designated input field.</p>';
                    aiResponseModal.classList.remove('hidden');
                    return;
                }
                aiModalTitle.textContent = 'AI BUDGETING ADVISOR';
                const budgetSummary = getBudgetStringForAI();
                const prompt = `Current U.S. federal budget simulator state:\n${budgetSummary}\n\nUser Goal: "${userGoal}".\nProvide concise, actionable advice: Adjust which specific subcategories (suggest % point changes of total budget or approx. USD changes) to achieve this goal. Consider trade-offs with other subcategories/main categories. Output: 2-3 paragraphs for retro-futuristic terminal display.`;
                await callGeminiAPI(prompt);
            }

            async function handleExplainConsequence(consequenceText) {
                aiModalTitle.textContent = 'AI CONSEQUENCE DECRYPTION';
                const prompt = `Explain the U.S. federal budget consequence below in detail. Provide context/real-world implications. Output: 1-2 concise paragraphs for retro-futuristic terminal display.\nConsequence: "${consequenceText}"`;
                await callGeminiAPI(prompt);
            }
            
            async function handleSuggestAlternatives(subCategoryName, parentCategoryName, consequenceText) {
                aiModalTitle.textContent = 'AI ALTERNATIVE SOLUTIONS';
                const budgetSummary = getBudgetStringForAI();
                const prompt = `U.S. federal budget: Subcategory '${subCategoryName}' (Sector: '${parentCategoryName}') significantly adjusted. Consequence: '${consequenceText}'.\n\n${budgetSummary}\n\nSuggest 2-3 alternative policy solutions/efficiencies for '${subCategoryName}' or broader '${parentCategoryName}' sector to mitigate negative impact or achieve similar goals more efficiently. Focus on creative/nuanced approaches. Output: Concise list for retro-futuristic terminal.`;
                await callGeminiAPI(prompt);
            }

            closeModalButton.addEventListener('click', () => {
                introModal.style.opacity = '0';
                introModal.style.pointerEvents = 'none';
                setTimeout(() => { introModal.style.display = 'none'; }, 300);
            });

            resetButton.addEventListener('click', resetApp);
            generateAnalysisButton.addEventListener('click', handleGenerateOverallAnalysis);
            getAIAdviceButton.addEventListener('click', handleGetAIAdvice);
            closeAIResponseModalButton.addEventListener('click', () => {
                aiResponseModal.classList.add('hidden');
            });
            
            updateToggleLabels();
            createSliders(); 
            initChart();
            updateAll(); 

            const firstCategorySection = slidersAndCategoriesContainer.firstChild;
            if (firstCategorySection) {
                firstCategorySection.before(latestImpactDisplay);
            } else { 
                slidersAndCategoriesContainer.prepend(latestImpactDisplay);
            }
            generateAnalysisButton.disabled = true; 
        });
    </script>
</body>
</html>
